/*! formstone v1.3.3 [dropdown.js] 2017-08-17 | GPL-3.0 License | formstone.it */
!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./scrollbar","./touch"],e):e(jQuery,Formstone)}(function(e,t){"use strict";function l(t){for(var l="",i=0,o=t.$allOptions.length;i<o;i++){var s=t.$allOptions.eq(i),d=[];if("OPTGROUP"===s[0].tagName)d.push(g.group),s.prop("disabled")&&d.push(g.disabled),l+='<span class="'+d.join(" ")+'">'+s.attr("label")+"</span>";else{var a=s.val(),n=s.data("label"),r=t.links?"a":'button type="button"';s.attr("value")||s.attr("value",a),d.push(g.item),s.hasClass(g.item_placeholder)&&(d.push(g.item_placeholder),r="span"),s.prop("selected")&&d.push(g.item_selected),s.prop("disabled")&&d.push(g.item_disabled),l+="<"+r+' class="'+d.join(" ")+'"',t.links?"span"===r?l+=' aria-hidden="true"':(l+=' href="'+a+'"',t.external&&(l+=' target="_blank"')):l+=' data-value="'+a+'"',l+=' role="option"',s.prop("selected")&&(l+=' "aria-selected"="true"'),l+=">",l+=n||I.decodeEntities(v(s.text(),t.trim)),l+="</"+r+">",0}}t.$items=t.$wrapper.html(e.parseHTML(l)).find(w.item)}function i(e){I.killEvent(e);var t=e.data;t.disabled||t.mobile||(t.closed?s(t):d(t)),o(t)}function o(t){e(w.base).not(t.$dropdown).trigger(C.close,[t])}function s(e){if(e.closed){var t=_.height(),l=e.$wrapper.outerHeight(!0);e.$dropdown[0].getBoundingClientRect().bottom+l>t-e.bottomEdge&&e.$dropdown.addClass(g.bottom),y.on(C.click+e.dotGuid,":not("+w.options+")",e,a),e.$dropdown.trigger(C.focusIn),e.$dropdown.addClass(g.open),b(e),e.closed=!1}}function d(e){e&&!e.closed&&(y.off(C.click+e.dotGuid),e.$dropdown.removeClass([g.open,g.bottom].join(" ")),e.closed=!0)}function a(t){I.killEvent(t);var l=t.data;l&&0===e(t.currentTarget).parents(w.base).length&&(d(l),l.$dropdown.trigger(C.focusOut))}function n(e){var t=e.data;t&&(d(t),t.$dropdown.trigger(C.focusOut))}function r(t){var l=e(this),i=t.data;if(I.killEvent(t),!i.disabled){var o=i.$items.index(l);i.focusIndex=o,i.$wrapper.is(":visible")&&(m(o,i,t.shiftKey,t.metaKey||t.ctrlKey),$(i)),i.multiple||d(i),i.$dropdown.trigger(C.focus)}}function p(t,l){e(this);var i=t.data;if(!l&&!i.multiple){var o=i.$options.index(i.$options.filter(":selected"));i.focusIndex=o,m(o,i),$(i,!0)}}function c(t){I.killEvent(t);e(t.currentTarget);var l=t.data;l.disabled||l.multiple||l.focused||(o(l),l.focused=!0,l.focusIndex=l.index,l.input="",l.$dropdown.addClass(g.focus).on(C.keyDown+l.dotGuid,l,f))}function u(t){I.killEvent(t);e(t.currentTarget);var l=t.data;l.focused&&l.closed&&(l.focused=!1,l.$dropdown.removeClass(g.focus).off(C.keyDown+l.dotGuid),l.multiple||(d(l),l.index!==l.focusIndex&&($(l),l.focusIndex=l.index)))}function f(l){var i=l.data;if(i.keyTimer=I.startTimer(i.keyTimer,1e3,function(){i.input=""}),13===l.keyCode)i.closed||(d(i),m(i.index,i)),$(i);else if(!(9===l.keyCode||l.metaKey||l.altKey||l.ctrlKey||l.shiftKey)){I.killEvent(l);var o=i.$items.length-1,s=i.index<0?0:i.index;if(e.inArray(l.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)(s+=38===l.keyCode||t.isFirefox&&37===l.keyCode?-1:1)<0&&(s=0),s>o&&(s=o);else{var a,n=String.fromCharCode(l.keyCode).toUpperCase();for(i.input+=n,a=i.index+1;a<=o;a++)if(i.$options.eq(a).text().substr(0,i.input.length).toUpperCase()===i.input){s=a;break}if(s<0||s===i.index)for(a=0;a<=o;a++)if(i.$options.eq(a).text().substr(0,i.input.length).toUpperCase()===i.input){s=a;break}}s>=0&&(m(s,i),b(i))}}function m(e,t,l,i){var o=t.$items.eq(e),s=t.$options.eq(e),d=o.hasClass(g.item_selected);if(!o.hasClass(g.item_disabled))if(t.multiple)if(t.mobile)d?(s.prop("selected",null).attr("aria-selected",null),o.removeClass(g.item_selected)):(s.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected));else if(l&&!1!==t.lastIndex){var a=t.lastIndex>e?e:t.lastIndex,n=(t.lastIndex>e?t.lastIndex:e)+1;t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(w.item_selected).removeClass(g.item_selected),t.$options.slice(a,n).not("[disabled]").prop("selected",!0),t.$items.slice(a,n).not(w.item_disabled).addClass(g.item_selected)}else i?(d?(s.prop("selected",null).attr("aria-selected",null),o.removeClass(g.item_selected)):(s.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected)),t.lastIndex=e):(t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(w.item_selected).removeClass(g.item_selected),s.prop("selected",!0).attr("aria-selected",!0),o.addClass(g.item_selected),t.lastIndex=e);else if(e>-1&&e<t.$items.length){if(e!==t.index){var r=s.data("label")||o.html();t.$selected.html(r).removeClass(w.item_placeholder),t.$items.filter(w.item_selected).removeClass(g.item_selected),t.$el[0].selectedIndex=e,o.addClass(g.item_selected),t.index=e}}else""!==t.label&&t.$selected.html(t.label)}function b(t){var l=t.$items.eq(t.index),i=t.index>=0&&!l.hasClass(g.item_placeholder)?l.position():{left:0,top:0},o=(t.$wrapper.outerHeight()-l.outerHeight())/2;void 0!==e.fn.fsScrollbar?t.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",t.$wrapper.find(".fs-scrollbar-content").scrollTop()+i.top):t.$wrapper.scrollTop(t.$wrapper.scrollTop()+i.top-o)}function $(e,t){e.links?h(e):t||e.$el.trigger(C.raw.change,[!0])}function h(e){var t=e.$el.val();e.external?k.open(t):k.location.href=t}function v(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}var x=t.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,theme:"fs-light",trim:0},methods:{_setup:function(){y=t.$body},_construct:function(t){t.multiple=this.prop("multiple"),t.disabled=this.prop("disabled")||this.is("[readonly]"),t.lastIndex=!1,t.multiple?t.links=!1:t.external&&(t.links=!0);var o=this.find("[selected]").not(":disabled"),s=this.find(":selected").not(":disabled"),d=s.text(),a=this.find("option").index(s);t.multiple||""===t.label||o.length?t.label="":(s=this.prepend('<option value="" class="'+g.item_placeholder+'" selected>'+t.label+"</option>"),d=t.label,a=0);var f=this.find("option, optgroup"),b=f.filter("option"),$=e("[for="+this.attr("id")+"]");t.tabIndex=this[0].tabIndex,this[0].tabIndex=-1,$.length&&($[0].tabIndex=-1);var h=[g.base,t.theme,t.customClass];t.mobile?h.push(g.mobile):t.cover&&h.push(g.cover),t.multiple&&h.push(g.multiple),t.disabled&&h.push(g.disabled),t.id=this.attr("id"),t.id?t.ariaId=t.id:t.ariaId=t.rawGuid,t.ariaId+="-dropdown",t.selectedAriaId=t.ariaId+"-selected";var x="",I="";x+='<div class="'+h.join(" ")+'"id="'+t.ariaId+'" tabindex="'+t.tabIndex+'" role="listbox"',t.multiple?x+=' aria-label="multi select"':x+=' aria-haspopup="true" aria-live="polite" aria-labeledby="'+t.selectedAriaId+'"',x+="></div>",t.multiple||(I+='<button type="button" class="'+g.selected+'" id="'+t.selectedAriaId+'" tabindex="-1">',I+=e("<span></span>").text(v(d,t.trim)).html(),I+="</button>"),I+='<div class="'+g.options+'">',I+="</div>",this.wrap(x).after(I),t.$dropdown=this.parent(w.base),t.$label=$,t.$allOptions=f,t.$options=b,t.$selected=t.$dropdown.find(w.selected),t.$wrapper=t.$dropdown.find(w.options),t.$placeholder=t.$dropdown.find(w.placeholder),t.index=-1,t.closed=!0,t.focused=!1,l(t),t.multiple||m(a,t),void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar({theme:t.theme}).find(".fs-scrollbar-content").attr("tabindex",null),t.$dropdown.on(C.click,t,i),t.$selected.on(C.click,t,i),t.$dropdown.on(C.click,w.item,t,r).on(C.close,t,n),this.on(C.change,t,p),t.mobile||(this.on(C.focusIn,t,function(e){e.data.$dropdown.trigger(C.raw.focus)}),t.$dropdown.on(C.focusIn,t,c).on(C.focusOut,t,u))},_destruct:function(t){t.$dropdown.hasClass(g.open)&&t.$selected.trigger(C.click),void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar("destroy"),t.$el[0].tabIndex=t.tabIndex,t.$label.length&&(t.$label[0].tabIndex=t.tabIndex),t.$dropdown.off(C.namespace),t.$options.off(C.namespace),t.$placeholder.remove(),t.$selected.remove(),t.$wrapper.remove(),t.$el.off(C.namespace).show().unwrap()},disable:function(e,t){if(void 0!==t){var l=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(l).addClass(g.item_disabled),e.$options.eq(l).prop("disabled",!0)}else e.$dropdown.hasClass(g.open)&&e.$selected.trigger(C.click),e.$dropdown.addClass(g.disabled),e.$el.prop("disabled",!0),e.disabled=!0},enable:function(e,t){if(void 0!==t){var l=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(l).removeClass(g.item_disabled),e.$options.eq(l).prop("disabled",!1)}else e.$dropdown.removeClass(g.disabled),e.$el.prop("disabled",!1),e.disabled=!1},update:function(t){void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar("destroy");var i=t.index;t.$allOptions=t.$el.find("option, optgroup"),t.$options=t.$allOptions.filter("option"),t.index=-1,i=t.$options.index(t.$options.filter(":selected")),l(t),t.multiple||m(i,t),void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar({theme:t.theme}).find(".fs-scrollbar-content").attr("tabindex",null)},open:s,close:d},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),w=x.classes,g=w.raw,C=x.events,I=x.functions,k=t.window,_=t.$window,y=(t.document,null)});